<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Stepper & LED 控制器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #111827; /* Fallback background */
        }
        .command-display {
            font-family: 'Courier New', Courier, monospace;
        }
        button:disabled, select:disabled, input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        /* For webkit-based browsers */
        #logContainer::-webkit-scrollbar, #scheduleList::-webkit-scrollbar {
            width: 8px;
        }
        #logContainer::-webkit-scrollbar-track, #scheduleList::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        #logContainer::-webkit-scrollbar-thumb, #scheduleList::-webkit-scrollbar-thumb {
            background-color: #718096; /* bg-gray-500 */
            border-radius: 4px;
        }
        .schedule-item.running {
            background-color: #10B981; /* bg-emerald-500 */
            color: white;
        }
        .schedule-item.paused {
            background-color: #FBBF24; /* bg-amber-400 */
            color: black;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .toggle-icon {
            transition: transform 0.3s;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="text-gray-800 p-4 md:p-8">

<canvas id="particle-canvas"></canvas>

<div class="max-w-4xl mx-auto bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-indigo-800 border-b-2 border-indigo-500 pb-4 mb-6">Modbus 步進馬達 & LED 控制網頁 (整合版)</h1>

    <!-- Connection Area -->
    <div class="bg-gray-50/80 p-4 rounded-lg border border-gray-200 mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">連線設定</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center mb-4">
            <div>
                <label for="baudRate" class="block text-sm font-medium text-gray-700">波特率</label>
                <select id="baudRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="9600" selected>9600</option>
                    <option value="19200">19200</option>
                    <option value="38400">38400</option>
                    <option value="57600">57600</option>
                    <option value="115200">115200</option>
                </select>
            </div>
            <div>
                <label for="dataBits" class="block text-sm font-medium text-gray-700">數據位</label>
                <select id="dataBits" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="8" selected>8</option>
                    <option value="7">7</option>
                </select>
            </div>
            <div>
                <label for="stopBits" class="block text-sm font-medium text-gray-700">停止位</label>
                <select id="stopBits" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                </select>
            </div>
            <div>
                <label for="parity" class="block text-sm font-medium text-gray-700">奇偶校驗</label>
                <select id="parity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="none" selected>None</option>
                    <option value="even">Even</option>
                    <option value="odd">Odd</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center mb-4">
            <div>
                <label for="responseTimeout" class="block text-sm font-medium text-gray-700">響應超時 (ms)</label>
                <input type="number" id="responseTimeout" value="1000" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="pollDelay" class="block text-sm font-medium text-gray-700">輪詢延遲 (ms)</label>
                <input type="number" id="pollDelay" value="500" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
        </div>
        <div class="flex items-center gap-4 mt-4">
            <button id="connectButton" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                連接 USB 設備
            </button>
            <div id="status" class="font-bold text-red-600">狀態: 未連接</div>
        </div>

        <!-- Log Display -->
        <div class="mt-4">
            <div id="logContainer" class="w-full h-48 bg-gray-900 text-white font-mono text-xs p-2 rounded-md overflow-y-auto">
                <!-- Log messages will be appended here -->
            </div>
            <div class="flex justify-end gap-2 mt-2">
                <button id="saveLogButton" class="bg-gray-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-gray-600 text-sm">保存日誌</button>
                <button id="clearLogButton" class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">清除日誌</button>
            </div>
        </div>
    </div>
    
    <!-- Global Slave ID -->
    <div class="mb-6 flex items-center">
        <label for="slaveId" class="text-lg font-bold text-gray-700 mr-4">通用 Slave ID:</label>
        <select id="slaveId" class="block w-32 mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            <!-- Options will be generated by JS -->
        </select>
    </div>

    <!-- Control Blocks -->
    <div class="space-y-6">
        <!-- Block 1: System Control -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                <h3 class="text-lg font-semibold text-indigo-700">功能 1: 馬達系統控制</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="px-5 pb-5 border-t border-gray-200 pt-4 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="p-3 border rounded-lg space-y-2 flex flex-col">
                            <button class="sendButton w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600" data-target="homing" disabled>執行歸位校正</button>
                            <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-2 text-sm" id="commandHoming"></div>
                            <button class="addToScheduleButton mt-auto w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="homing" data-desc="執行歸位">+ 添加至節目表</button>
                        </div>
                        <div class="p-3 border rounded-lg space-y-2 flex flex-col">
                             <button class="sendButton w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600" data-target="forceStop" disabled>強制停止</button>
                             <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-2 text-sm" id="commandForceStop"></div>
                             <button class="addToScheduleButton mt-auto w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="forceStop" data-desc="強制停止">+ 添加至節目表</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Block 2: Read Status -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                <h3 class="text-lg font-semibold text-indigo-700">功能 2: 讀取狀態</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="px-5 pb-5 border-t border-gray-200 pt-4 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button class="sendButton w-full bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600" data-target="readStatus" disabled>讀取馬達狀態</button>
                        <button class="sendButton w-full bg-sky-500 text-white py-2 rounded-lg hover:bg-sky-600" data-target="readLeftLimit" disabled>讀取左極限</button>
                        <button class="sendButton w-full bg-sky-500 text-white py-2 rounded-lg hover:bg-sky-600" data-target="readRightLimit" disabled>讀取右極限</button>
                    </div>
                    <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-3 text-sm" id="commandReadStatus"></div>
                    <div class="mt-3 p-3 bg-gray-100 rounded">
                        <h4 class="font-bold">回傳結果:</h4>
                        <div id="readResult" class="font-mono mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2">N/A</div>
                    </div>
                    <button class="addToScheduleButton mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="readStatus" data-desc="讀取馬達狀態">+ 添加至節目表</button>
                </div>
            </div>
        </div>

        <!-- Block 3: Motor Movement -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                 <h3 class="text-lg font-semibold text-indigo-700">功能 3: 馬達運動</h3>
                 <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                 <div class="px-5 pb-5 border-t border-gray-200 pt-4 space-y-4">
                    <div class="flex items-center">
                        <label for="motorSpeed" class="w-32 font-medium">速度 (μs/step):</label>
                        <input type="number" id="motorSpeed" value="1000" min="200" class="flex-grow rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="flex items-center">
                        <label for="motorDirection" class="w-32 font-medium">方向:</label>
                        <select id="motorDirection" class="flex-grow rounded-md border-gray-300 shadow-sm">
                            <option value="1">正轉 (Forward)</option>
                            <option value="0">反轉 (Reverse)</option>
                        </select>
                    </div>
                     <div class="flex items-center">
                        <label for="motorRevolutions" class="w-32 font-medium">圈數:</label>
                        <input type="number" id="motorRevolutions" value="1" min="1" class="flex-grow rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button id="executeMotorMove" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600" disabled>發送運動指令</button>
                    <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-3 text-sm" id="commandMotorMove"></div>
                    <button class="addToScheduleButton mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="motorMove" data-desc="馬達運動">+ 添加至節目表</button>
                </div>
            </div>
        </div>

        <!-- Block 4: LED Effects -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                <h3 class="text-lg font-semibold text-indigo-700">功能 4: 通用燈光特效</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="px-5 pb-5 border-t border-gray-200 pt-4 space-y-4">
                     <div class="p-3 border rounded-lg space-y-3">
                        <h4 class="font-semibold text-gray-700">通用參數</h4>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <label for="effectColor" class="block text-sm font-medium">顏色 (R,G,B):</label>
                                 <div class="flex items-center gap-2 mt-1">
                                    <input type="number" id="effectColorR" value="255" min="0" max="255" class="w-full rounded-md border-gray-300">
                                    <input type="number" id="effectColorG" value="0" min="0" max="255" class="w-full rounded-md border-gray-300">
                                    <input type="number" id="effectColorB" value="0" min="0" max="255" class="w-full rounded-md border-gray-300">
                                 </div>
                             </div>
                             <div>
                                 <label for="effectBrightness" class="block text-sm font-medium">亮度:</label>
                                 <div class="flex items-center gap-2 mt-1">
                                     <input type="range" id="effectBrightness" min="0" max="255" value="255" class="flex-grow">
                                     <span id="effectBrightnessValue" class="ml-2 w-8 text-center font-mono">255</span>
                                 </div>
                             </div>
                             <div>
                                <label for="effectOnTime" class="block text-sm font-medium">開啟/速度 (ms):</label>
                                <input type="number" id="effectOnTime" value="500" min="1" class="w-full rounded-md border-gray-300 mt-1">
                             </div>
                              <div>
                                <label for="effectOffTime" class="block text-sm font-medium">關閉時間 (ms):</label>
                                <input type="number" id="effectOffTime" value="500" min="1" class="w-full rounded-md border-gray-300 mt-1">
                             </div>
                              <div class="col-span-2">
                                <label for="effectLedCount" class="block text-sm font-medium">LED 數量:</label>
                                <input type="number" id="effectLedCount" value="25" min="1" max="25" class="w-full rounded-md border-gray-300 mt-1">
                             </div>
                         </div>
                    </div>

                    <div class="p-3 border rounded-lg">
                        <h4 class="font-semibold mb-3 text-gray-700">觸發特效</h4>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            <button class="effectTriggerButton w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600" data-effect-id="1" disabled>恆亮</button>
                            <button class="effectTriggerButton w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600" data-effect-id="2" disabled>呼吸</button>
                            <button class="effectTriggerButton w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600" data-effect-id="3" disabled>閃爍</button>
                            <button class="effectTriggerButton w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600" data-effect-id="0" disabled>關閉</button>
                        </div>
                        <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-3 text-sm" id="commandEffect"></div>
                        <button class="addToScheduleButton mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="effect" data-desc="通用特效">+ 添加至節目表</button>
                    </div>

                    <div class="p-3 border rounded-lg">
                        <h4 class="font-semibold mb-2 text-gray-700">流星特效 (獨立)</h4>
                        <div class="flex items-center">
                            <label for="meteorSpeed" class="w-32 font-medium">速度 (ms):</label>
                            <input type="number" id="meteorSpeed" value="40" min="20" class="flex-grow rounded-md border-gray-300 shadow-sm">
                        </div>
                         <div class="flex items-center mt-2">
                            <label for="meteorCount" class="w-32 font-medium">LED 數量:</label>
                            <input type="number" id="meteorCount" value="25" min="1" max="25" class="flex-grow rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                            <div class="space-y-2 flex flex-col">
                                <button id="triggerMeteor" class="w-full bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600" disabled>觸發流星</button>
                                <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md text-sm" id="commandMeteor"></div>
                                <button class="addToScheduleButton mt-auto w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="meteor" data-desc="觸發流星">+ 添加至節目表</button>
                            </div>
                            <div class="space-y-2 flex flex-col">
                                <button class="sendButton w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600" data-target="stopMeteor" disabled>停止流星</button>
                                <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md text-sm" id="commandStopMeteor"></div>
                                <button class="addToScheduleButton mt-auto w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="stopMeteor" data-desc="停止流星">+ 添加至節目表</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Block 5: Force Slave ID -->
        <div class="control-block bg-yellow-50/80 rounded-lg border border-yellow-300 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                <h3 class="text-lg font-semibold text-yellow-800">功能 5: 強制設定 Slave ID (慎用)</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="px-5 pb-5 border-t border-yellow-200 pt-4 space-y-4">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p class="font-bold">警告!</p>
                        <p>此操作會將新的 Slave ID 寫入裝置的永久記憶體 (EEPROM) 並重新啟動裝置。請謹慎操作。</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <label for="newSlaveId" class="font-medium">新 Slave ID (1-247):</label>
                        <input type="number" id="newSlaveId" value="1" min="1" max="247" class="flex-grow rounded-md border-gray-300 shadow-sm">
                        <button id="forceIdButton" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600" disabled>設定新ID</button>
                    </div>
                     <div class="flex items-center gap-4">
                        <button id="revertIdButton" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" disabled>還原為硬體 DIP 開關 ID</button>
                    </div>
                    <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md text-sm" id="commandForceId"></div>
                </div>
            </div>
        </div>

        <!-- Block 6: On/Off (Legacy) -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                <h3 class="text-lg font-semibold text-indigo-700">功能 6: 舊版 LED 開關</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="px-5 pb-5 border-t border-gray-200">
                    <div class="flex items-center my-4">
                        <label for="effectOnOff" class="w-24 font-medium">模式:</label>
                        <select id="effectOnOff" class="flex-grow rounded-md border-gray-300 shadow-sm">
                            <option value="1">恆亮 (Solid On)</option>
                            <option value="0">關閉 (Off)</option>
                        </select>
                    </div>
                    <button class="sendButton w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600" data-target="onOff" disabled>發送指令</button>
                    <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-3 text-sm" id="commandOnOff"></div>
                    <button class="addToScheduleButton mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="onOff" data-desc="舊版 LED 開關">+ 添加至節目表</button>
                </div>
            </div>
        </div>

        <!-- Block 7: Breathing (Legacy) -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                 <h3 class="text-lg font-semibold text-indigo-700">功能 7: 舊版呼吸模式</h3>
                 <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                 <div class="px-5 pb-5 border-t border-gray-200">
                    <div class="flex items-center my-4">
                        <label for="breathingTime" class="w-32 font-medium">呼吸週期 (ms):</label>
                        <input type="number" id="breathingTime" value="3000" min="100" class="flex-grow rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button class="sendButton w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600" data-target="breathing" disabled>發送指令</button>
                    <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-3 text-sm" id="commandBreathing"></div>
                    <button class="addToScheduleButton mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="breathing" data-desc="舊版呼吸模式">+ 添加至節目表</button>
                </div>
            </div>
        </div>

        <!-- Block 8: Blinking (Legacy) -->
        <div class="control-block bg-white/80 rounded-lg border border-gray-200 shadow-sm">
            <div class="collapsible-header flex justify-between items-center p-5 cursor-pointer">
                <h3 class="text-lg font-semibold text-indigo-700">功能 8: 舊版閃爍模式</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="px-5 pb-5 border-t border-gray-200">
                    <div class="flex items-center mt-4 mb-2">
                        <label for="blinkingOnTime" class="w-32 font-medium">亮燈時間 (ms):</label>
                        <input type="number" id="blinkingOnTime" value="200" min="1" class="flex-grow rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="flex items-center mb-4">
                        <label for="blinkingOffTime" class="w-32 font-medium">滅燈時間 (ms):</label>
                        <input type="number" id="blinkingOffTime" value="800" min="1" class="flex-grow rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button class="sendButton w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600" data-target="blinking" disabled>發送指令</button>
                    <div class="command-display bg-gray-900 text-green-400 p-3 rounded-md mt-3 text-sm" id="commandBlinking"></div>
                    <button class="addToScheduleButton mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded-md hover:bg-gray-300 text-sm" data-target="blinking" data-desc="舊版閃爍模式">+ 添加至節目表</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generic Command Calculator -->
    <div class="mt-8 pt-6 border-t-2 border-gray-200">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">通用指令計算器</h2>
        <div class="bg-white/80 p-5 rounded-lg border border-gray-200 shadow-sm">
            <label for="genericCommandInput" class="block text-sm font-medium text-gray-700 mb-2">輸入Modbus指令 (Hex格式，不含CRC):</label>
            <input type="text" id="genericCommandInput" placeholder="例如: 01 10 00 00 00 03 06 00 03 00 C8 03 20" class="w-full font-mono rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            <div class="mt-4 flex items-center gap-4">
                 <button id="copyGenericCommand" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">複製</button>
                 <button id="sendGenericCommand" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300" disabled>發送指令</button>
                 <div id="genericCommandOutput" class="command-display bg-gray-900 text-green-400 p-3 rounded-md text-sm flex-grow">請輸入指令...</div>
            </div>
            <div id="copyFeedback" class="text-green-600 mt-2 h-4"></div>
        </div>
    </div>

    <!-- Program Schedule -->
    <div class="mt-8 pt-6 border-t-2 border-gray-200">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">節目表演示</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/80 p-5 rounded-lg border border-gray-200 shadow-sm space-y-3">
                <h3 class="text-lg font-semibold text-gray-700">添加步驟</h3>
                <div class="p-2 border rounded-md border-gray-300 space-y-2">
                    <div class="flex items-center gap-2">
                        <label for="delayTime" class="font-medium text-sm">延遲(ms):</label>
                        <input type="number" id="delayTime" value="1000" min="1" class="flex-grow rounded-md border-gray-300 shadow-sm w-full">
                        <button id="addDelayButton" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">添加</button>
                    </div>
                </div>
                 <div class="p-2 border rounded-md border-gray-300 space-y-2">
                    <div class="flex items-center gap-2 flex-wrap mb-2">
                         <label class="font-medium text-sm">If (ID-</label>
                         <input type="number" id="ifSlaveId" value="1" min="1" max="247" class="rounded-md border-gray-300 shadow-sm w-16">
                         <label class="font-medium text-sm">LastStatus ==</label>
                         <input type="number" id="ifValue" value="3" class="rounded-md border-gray-300 shadow-sm w-16">
                         <label class="font-medium text-sm">)</label>
                         <button id="addIfButton" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 flex-grow">添加 If</button>
                    </div>
                     <div class="flex items-center gap-2 flex-wrap">
                         <label class="font-medium text-sm">Else If (ID-</label>
                         <input type="number" id="elseifSlaveId" value="1" min="1" max="247" class="rounded-md border-gray-300 shadow-sm w-16">
                         <label class="font-medium text-sm">LastStatus ==</label>
                         <input type="number" id="elseifValue" value="3" class="rounded-md border-gray-300 shadow-sm w-16">
                         <label class="font-medium text-sm">)</label>
                         <button id="addElseIfButton" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 flex-grow">添加 ElseIf</button>
                    </div>
                     <div class="text-xs text-gray-500 mt-1">狀態碼: 0=未歸位, 1=移動中, 2=歸位中, 3=完成, 4=錯誤</div>
                    <div class="flex items-center gap-2 mt-2">
                        <button id="addElseButton" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 flex-grow">添加 Else</button>
                        <button id="addEndIfButton" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 flex-grow">添加 End If</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <label for="scheduleNote" class="font-medium">註解:</label>
                    <input type="text" id="scheduleNote" placeholder="選填，方便記憶" class="flex-grow rounded-md border-gray-300 shadow-sm w-full">
                </div>
            </div>
            <div class="bg-white/80 p-5 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">目前節目表</h3>
                <ol id="scheduleList" class="list-decimal list-inside bg-gray-50 p-2 rounded h-96 overflow-y-auto space-y-1"></ol>
                <div class="flex justify-between items-center mt-3 flex-wrap gap-2">
                    <div class="flex gap-2 items-center">
                        <button id="runScheduleButton" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 disabled:bg-emerald-300" disabled>▶️ 執行</button>
                        <button id="pauseScheduleButton" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 disabled:bg-blue-300" disabled>⏸️ 暫停</button>
                        <button id="stopScheduleButton" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 disabled:bg-yellow-300" disabled>⏹️ 停止</button>
                        <div class="flex items-center ml-2">
                            <input type="checkbox" id="loopScheduleCheckbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="loopScheduleCheckbox" class="ml-2 block text-sm font-medium text-gray-700">循環</label>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="saveScheduleButton" class="bg-indigo-500 text-white font-bold py-2 px-2 rounded-lg hover:bg-indigo-600 text-sm">💾 儲存</button>
                        <button id="loadScheduleButton" class="bg-purple-500 text-white font-bold py-2 px-2 rounded-lg hover:bg-purple-600 text-sm">📂 載入</button>
                        <button id="clearScheduleButton" class="bg-red-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-red-700 text-sm">🗑️ 清空</button>
                    </div>
                </div>
                <input type="file" id="scheduleFileInput" class="hidden" accept=".json">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global Variables ---
        let port;
        let writer;
        let reader;
        let schedule = [];
        let isSequenceRunning = false;
        let isPaused = false;
        let lastReadValue = { id: null, value: null }; // For schedule conditions
        
        // --- UI Elements ---
        const ui = {
            connectButton: document.getElementById('connectButton'),
            baudRate: document.getElementById('baudRate'),
            dataBits: document.getElementById('dataBits'),
            stopBits: document.getElementById('stopBits'),
            parity: document.getElementById('parity'),
            responseTimeout: document.getElementById('responseTimeout'),
            pollDelay: document.getElementById('pollDelay'),
            status: document.getElementById('status'),
            logContainer: document.getElementById('logContainer'),
            saveLogButton: document.getElementById('saveLogButton'),
            clearLogButton: document.getElementById('clearLogButton'),
            slaveId: document.getElementById('slaveId'),
            sendButtons: document.querySelectorAll('.sendButton'),
            addToScheduleButtons: document.querySelectorAll('.addToScheduleButton'),
            readResult: document.getElementById('readResult'),
            // Motor & New LED UI Elements
            motorSpeed: document.getElementById('motorSpeed'),
            motorDirection: document.getElementById('motorDirection'),
            motorRevolutions: document.getElementById('motorRevolutions'),
            executeMotorMove: document.getElementById('executeMotorMove'),
            meteorSpeed: document.getElementById('meteorSpeed'),
            meteorCount: document.getElementById('meteorCount'),
            triggerMeteor: document.getElementById('triggerMeteor'),
            // Generic Command UI
            genericCommandInput: document.getElementById('genericCommandInput'),
            genericCommandOutput: document.getElementById('genericCommandOutput'),
            copyGenericCommand: document.getElementById('copyGenericCommand'),
            sendGenericCommand: document.getElementById('sendGenericCommand'),
            copyFeedback: document.getElementById('copyFeedback'),
            // Generic Effect UI
            effectColorR: document.getElementById('effectColorR'),
            effectColorG: document.getElementById('effectColorG'),
            effectColorB: document.getElementById('effectColorB'),
            effectBrightness: document.getElementById('effectBrightness'),
            effectBrightnessValue: document.getElementById('effectBrightnessValue'),
            effectOnTime: document.getElementById('effectOnTime'),
            effectOffTime: document.getElementById('effectOffTime'),
            effectLedCount: document.getElementById('effectLedCount'),
            effectTriggerButtons: document.querySelectorAll('.effectTriggerButton'),
            // New Slave ID UI
            newSlaveId: document.getElementById('newSlaveId'),
            forceIdButton: document.getElementById('forceIdButton'),
            revertIdButton: document.getElementById('revertIdButton'),
            // Legacy LED UI Elements
            effectOnOff: document.getElementById('effectOnOff'),
            breathingTime: document.getElementById('breathingTime'),
            blinkingOnTime: document.getElementById('blinkingOnTime'),
            blinkingOffTime: document.getElementById('blinkingOffTime'),
            commandDisplays: {
                homing: document.getElementById('commandHoming'),
                forceStop: document.getElementById('commandForceStop'),
                readStatus: document.getElementById('commandReadStatus'),
                readLeftLimit: document.getElementById('commandReadStatus'), 
                readRightLimit: document.getElementById('commandReadStatus'),
                motorMove: document.getElementById('commandMotorMove'),
                effect: document.getElementById('commandEffect'),
                meteor: document.getElementById('commandMeteor'),
                stopMeteor: document.getElementById('commandStopMeteor'),
                forceId: document.getElementById('commandForceId'),
                onOff: document.getElementById('commandOnOff'),
                breathing: document.getElementById('commandBreathing'),
                blinking: document.getElementById('commandBlinking'),
            },
            // Schedule UI
            delayTime: document.getElementById('delayTime'),
            scheduleNote: document.getElementById('scheduleNote'),
            addDelayButton: document.getElementById('addDelayButton'),
            ifSlaveId: document.getElementById('ifSlaveId'),
            ifValue: document.getElementById('ifValue'),
            addIfButton: document.getElementById('addIfButton'),
            elseifSlaveId: document.getElementById('elseifSlaveId'),
            elseifValue: document.getElementById('elseifValue'),
            addElseIfButton: document.getElementById('addElseIfButton'),
            addElseButton: document.getElementById('addElseButton'),
            addEndIfButton: document.getElementById('addEndIfButton'),
            scheduleList: document.getElementById('scheduleList'),
            runScheduleButton: document.getElementById('runScheduleButton'),
            pauseScheduleButton: document.getElementById('pauseScheduleButton'),
            stopScheduleButton: document.getElementById('stopScheduleButton'),
            loopScheduleCheckbox: document.getElementById('loopScheduleCheckbox'),
            clearScheduleButton: document.getElementById('clearScheduleButton'),
            saveScheduleButton: document.getElementById('saveScheduleButton'),
            loadScheduleButton: document.getElementById('loadScheduleButton'),
            scheduleFileInput: document.getElementById('scheduleFileInput')
        };

        // --- CRC16/MODBUS Calculation ---
        function crc16(bytes) {
            let crc = 0xFFFF;
            for (const byte of bytes) {
                crc ^= byte;
                for (let i = 0; i < 8; i++) {
                    if (crc & 1) {
                        crc = (crc >> 1) ^ 0xA001;
                    } else {
                        crc >>= 1;
                    }
                }
            }
            return crc;
        }
        
        // --- Logging Function ---
        function logMessage(direction, data) {
            const timestamp = new Date().toLocaleTimeString('en-GB');
            const hexString = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="${direction === 'TX' ? 'text-cyan-400' : 'text-yellow-400'}">${direction}:</span> ${hexString}`;
            
            ui.logContainer.appendChild(logEntry);
            ui.logContainer.scrollTop = ui.logContainer.scrollHeight;
        }

        // --- Command Generation ---
        function generateAndDisplayCommand(target, command) {
            const crc = crc16(command);
            const fullCommand = [...command, crc & 0xFF, (crc >> 8) & 0xFF];
            const hexString = fullCommand.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            if (ui.commandDisplays[target]) {
                 ui.commandDisplays[target].textContent = hexString;
                 ui.commandDisplays[target].dataset.command = JSON.stringify(fullCommand);
            }
            return fullCommand;
        }

        function generateAllCommands() {
            const slaveId = parseInt(ui.slaveId.value);
            if (isNaN(slaveId)) return;
            
            generateAndDisplayCommand('homing', [slaveId, 0x06, 0x00, 0x05, 0x00, 0x01]);
            generateAndDisplayCommand('forceStop', [slaveId, 0x06, 0x00, 0x08, 0x00, 0x01]);
            generateAndDisplayCommand('readStatus', [slaveId, 0x03, 0x00, 0x04, 0x00, 0x04]);
            generateAndDisplayCommand('readLeftLimit', [slaveId, 0x03, 0x00, 13, 0x00, 0x01]);
            generateAndDisplayCommand('readRightLimit', [slaveId, 0x03, 0x00, 14, 0x00, 0x01]);

            const speed = parseInt(ui.motorSpeed.value);
            const dir = parseInt(ui.motorDirection.value);
            const revs = parseInt(ui.motorRevolutions.value);
            const motorParamsCmd = [slaveId, 0x10, 0x00, 0x00, 0x00, 0x03, 0x06, 
                (speed >> 8) & 0xFF, speed & 0xFF, 0x00, dir, (revs >> 8) & 0xFF, revs & 0xFF];
            const fullMotorParamsCmd = generateAndDisplayCommand('motorMove', motorParamsCmd);
            const motorExecCmd = [slaveId, 0x06, 0x00, 0x03, 0x00, 0x01];
            ui.commandDisplays.motorMove.dataset.paramsCommand = JSON.stringify(fullMotorParamsCmd);
            ui.commandDisplays.motorMove.dataset.executeCommand = JSON.stringify(generateAndDisplayCommand('motorMoveExecute', motorExecCmd));

            const mSpeed = parseInt(ui.meteorSpeed.value);
            const mCount = parseInt(ui.meteorCount.value);
            const meteorParamsCmd = [slaveId, 0x10, 0x00, 0x0A, 0x00, 0x02, 0x04,
                (mSpeed >> 8) & 0xFF, mSpeed & 0xFF, (mCount >> 8) & 0xFF, mCount & 0xFF];
            const fullMeteorParamsCmd = generateAndDisplayCommand('meteor', meteorParamsCmd);
            const meteorTriggerCmd = [slaveId, 0x06, 0x00, 0x0C, 0x00, 0x01];
            ui.commandDisplays.meteor.dataset.paramsCommand = JSON.stringify(fullMeteorParamsCmd);
            ui.commandDisplays.meteor.dataset.triggerCommand = JSON.stringify(generateAndDisplayCommand('meteorTrigger', meteorTriggerCmd));
            generateAndDisplayCommand('stopMeteor', [slaveId, 0x06, 0x00, 0x0C, 0x00, 0x02]);
            
            generateEffectCommand(0); 
            generateForceIdCommand();
            
            // Legacy Commands
            const effect = parseInt(ui.effectOnOff.value);
            generateAndDisplayCommand('onOff', [slaveId, 0x06, 0x00, 0x00, 0x00, effect]);

            const breathTime = parseInt(ui.breathingTime.value);
            generateAndDisplayCommand('breathing', [slaveId, 0x10, 0x00, 0x00, 0x00, 0x02, 0x04, 0x00, 0x02, (breathTime >> 8) & 0xFF, breathTime & 0xFF]);
            
            const onTime = parseInt(ui.blinkingOnTime.value);
            const offTime = parseInt(ui.blinkingOffTime.value);
            generateAndDisplayCommand('blinking', [slaveId, 0x10, 0x00, 0x00, 0x00, 0x03, 0x06, 0x00, 0x03, (onTime >> 8) & 0xFF, onTime & 0xFF, (offTime >> 8) & 0xFF, offTime & 0xFF]);
        }
        
        function generateEffectCommand(effectId) {
            const slaveId = parseInt(ui.slaveId.value);
            const r = parseInt(ui.effectColorR.value);
            const g = parseInt(ui.effectColorG.value);
            const b = parseInt(ui.effectColorB.value);
            const onTime = parseInt(ui.effectOnTime.value);
            const offTime = parseInt(ui.effectOffTime.value);
            const count = parseInt(ui.effectLedCount.value);
            const brightness = parseInt(ui.effectBrightness.value);

            const paramsCmd = [slaveId, 0x10, 0x00, 15, 0x00, 0x07, 14,
                0, r, 0, g, 0, b,
                (onTime >> 8) & 0xFF, onTime & 0xFF,
                (offTime >> 8) & 0xFF, offTime & 0xFF,
                0, count, 0, brightness];
            const triggerCmd = [slaveId, 0x06, 0x00, 22, 0x00, effectId];

            const fullParamsCmd = generateAndDisplayCommand('effectParams', paramsCmd);
            const fullTriggerCmd = generateAndDisplayCommand('effect', triggerCmd);
            
            ui.commandDisplays.effect.dataset.paramsCommand = JSON.stringify(fullParamsCmd);
            ui.commandDisplays.effect.dataset.triggerCommand = JSON.stringify(fullTriggerCmd);
            ui.commandDisplays.effect.dataset.effectId = effectId;
        }

        function generateForceIdCommand() {
            const slaveId = parseInt(ui.slaveId.value);
            const newId = parseInt(ui.newSlaveId.value);
            generateAndDisplayCommand('forceId', [slaveId, 0x06, 0x00, 23, 0x00, newId]);
        }
        
        // --- WebUSB Functions ---
        async function connect() {
            try {
                port = await navigator.serial.requestPort();
                const serialOptions = {
                    baudRate: parseInt(ui.baudRate.value),
                    dataBits: parseInt(ui.dataBits.value),
                    stopBits: parseInt(ui.stopBits.value),
                    parity: ui.parity.value
                };
                await port.open(serialOptions);
                setSerialControlsState(true);
                writer = port.writable.getWriter();
                readLoop();
            } catch (error) {
                console.error('連接失敗:', error);
                ui.status.textContent = `錯誤: ${error.message}`;
            }
        }
        
        async function disconnect() {
            stopSchedule();
            const portToClose = port;
            port = null;
            if (reader) { try { await reader.cancel(); } catch(e) { console.warn(e); } }
            if (writer) { try { await writer.close(); } catch(e) { console.warn(e); } }
            if (portToClose) { try { await portToClose.close(); } catch(e) { console.warn(e); } }
            reader = null;
            writer = null;
            setSerialControlsState(false);
        }

        async function readLoop() {
            while (port && port.readable) {
                reader = port.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        handleIncomingData(value);
                    }
                } catch (error) {
                    console.error('讀取錯誤，連線已中斷:', error);
                    if (port) disconnect();
                } finally {
                    try { reader.releaseLock(); } catch(e) { /* Ignore */ }
                }
            }
        }
        
        function handleIncomingData(data) {
            logMessage('RX', data);
            ui.readResult.innerHTML = ''; 

            if (data.length === 13 && data[1] === 0x03 && data[2] === 0x08) {
                const slaveId = data[0];
                const status = (data[3] << 8) | data[4];
                const totalSteps = ((data[7] << 8) | data[8]) << 16 | ((data[9] << 8) | data[10]);
                lastReadValue = { id: slaveId, value: status };

                let statusText = {0: "未歸位", 1: "移動中", 2: "歸位中", 3: "待命中", 4: "歸位錯誤"}[status] || `Unknown (${status})`;
                ui.readResult.innerHTML = `
                    <span class="block">ID-${slaveId} Status: <strong class="text-blue-600">${statusText}</strong></span>
                    <span class="block col-span-2">Total Steps: <strong class="text-green-600">${totalSteps}</strong></span>`;

            } else if (data.length === 7 && data[1] === 0x03 && data[2] === 0x02) {
                const slaveId = data[0];
                const value = (data[3] << 8) | data[4];
                const lastCmd = ui.commandDisplays.readStatus.textContent;
                if (lastCmd.includes('00 0D')) {
                     ui.readResult.innerHTML = `<span class="block">ID-${slaveId} 左極限: <strong class="${value ? 'text-red-600' : 'text-gray-600'}">${value ? '觸發' : '正常'}</strong></span>`;
                } else if (lastCmd.includes('00 0E')) {
                     ui.readResult.innerHTML = `<span class="block">ID-${slaveId} 右極限: <strong class="${value ? 'text-red-600' : 'text-gray-600'}">${value ? '觸發' : '正常'}</strong></span>`;
                } else {
                     ui.readResult.innerHTML = `<span class="block">收到單一暫存器回覆: ${value}</span>`;
                }
            } else {
                const hexString = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
                ui.readResult.innerHTML = `<span class="block col-span-2">收到未知回覆: ${hexString}</span>`;
            }
        }

        async function sendRawCommand(commandBytes) {
             if (!port || !writer) return;
             const command = new Uint8Array(commandBytes);
             logMessage('TX', command);
             ui.commandDisplays.readStatus.textContent = Array.from(command).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
             await writer.write(command);
        }
        
        async function sendCommand(target) {
            await sendRawCommand(JSON.parse(ui.commandDisplays[target].dataset.command));
        }

        function setSerialControlsState(isConnected) {
            const elements = [ui.baudRate, ui.dataBits, ui.stopBits, ui.parity, ui.responseTimeout, ui.pollDelay, ui.executeMotorMove, ui.triggerMeteor, ui.runScheduleButton, ui.sendGenericCommand, ui.forceIdButton, ui.revertIdButton];
            elements.forEach(el => el.disabled = !isConnected);
            ui.sendButtons.forEach(b => b.disabled = !isConnected);
            ui.effectTriggerButtons.forEach(b => b.disabled = !isConnected);
            
            if (!isConnected) {
                ui.pauseScheduleButton.disabled = true;
                ui.stopScheduleButton.disabled = true;
            }

            ui.status.textContent = isConnected ? '狀態: 已連接' : '狀態: 未連接';
            ui.status.classList.toggle('text-green-600', isConnected);
            ui.status.classList.toggle('text-red-600', !isConnected);
            ui.connectButton.textContent = isConnected ? '斷開連接' : '連接 USB 設備';
        }
        
        // --- Schedule Functions ---
        function renderSchedule() {
            ui.scheduleList.innerHTML = '';
            let indentLevel = 0;
            schedule.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'schedule-item flex justify-between items-center p-1 bg-white rounded text-sm';
                li.dataset.index = index;

                if(item.type === 'else' || item.type === 'elseif' || item.type === 'endif') {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                li.style.marginLeft = `${indentLevel * 20}px`;
                if(item.type === 'if' || item.type === 'else' || item.type === 'elseif') {
                    indentLevel++;
                }
                
                const descContainer = document.createElement('div');
                descContainer.className = 'flex-grow flex flex-col';
                const mainDesc = document.createElement('span');
                mainDesc.textContent = item.description;
                mainDesc.className = 'font-semibold';
                if(item.type === 'if' || item.type === 'elseif') mainDesc.className += ' text-cyan-600';
                descContainer.appendChild(mainDesc);
                if (item.note) {
                    const noteDesc = document.createElement('span');
                    noteDesc.className = 'text-xs text-gray-500';
                    noteDesc.textContent = item.note;
                    descContainer.appendChild(noteDesc);
                }
                li.appendChild(descContainer);
                const controls = document.createElement('div');
                controls.className = 'flex items-center gap-1';
                const upBtn = document.createElement('button');
                upBtn.textContent = '🔼';
                upBtn.className = 'text-xs hover:bg-gray-200 rounded p-1 disabled:opacity-20';
                upBtn.disabled = index === 0;
                upBtn.onclick = () => moveScheduleItem(index, 'up');
                controls.appendChild(upBtn);
                const downBtn = document.createElement('button');
                downBtn.textContent = '🔽';
                downBtn.className = 'text-xs hover:bg-gray-200 rounded p-1 disabled:opacity-20';
                downBtn.disabled = index === schedule.length - 1;
                downBtn.onclick = () => moveScheduleItem(index, 'down');
                controls.appendChild(downBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '❌';
                deleteBtn.className = 'text-xs hover:bg-red-200 rounded p-1';
                deleteBtn.onclick = () => { schedule.splice(index, 1); renderSchedule(); };
                controls.appendChild(deleteBtn);
                li.appendChild(controls);
                ui.scheduleList.appendChild(li);
            });
        }

        function moveScheduleItem(index, direction) {
            if (direction === 'up' && index > 0) {
                [schedule[index], schedule[index - 1]] = [schedule[index - 1], schedule[index]];
            } else if (direction === 'down' && index < schedule.length - 1) {
                [schedule[index], schedule[index + 1]] = [schedule[index + 1], schedule[index]];
            }
            renderSchedule();
        }
        
        function findNextClause(startIndex) {
            let nestLevel = 0;
            for (let i = startIndex + 1; i < schedule.length; i++) {
                const item = schedule[i];
                if (item.type === 'if') nestLevel++;
                else if (item.type === 'endif') {
                    if (nestLevel === 0) return i;
                    nestLevel--;
                } else if (item.type === 'elseif' || item.type === 'else') {
                    if (nestLevel === 0) return i;
                }
            }
            return schedule.length;
        }
        
        function findMatchingEndif(startIndex) {
            let nestLevel = 0;
            for (let i = startIndex + 1; i < schedule.length; i++) {
                 if (schedule[i].type === 'if') nestLevel++;
                 else if (schedule[i].type === 'endif') {
                    if (nestLevel === 0) return i;
                    nestLevel--;
                }
            }
             return schedule.length;
        }

        async function executeSchedule() {
            isSequenceRunning = true;
            isPaused = false;
            ui.runScheduleButton.disabled = true;
            ui.pauseScheduleButton.disabled = false;
            ui.stopScheduleButton.disabled = false;

            const shouldLoop = ui.loopScheduleCheckbox.checked;

            do {
                let i = 0;
                let ifBlockMetStack = [];

                while(i < schedule.length && isSequenceRunning) {
                    while (isPaused && isSequenceRunning) await new Promise(r => setTimeout(r, 100));
                    if (!isSequenceRunning) break;

                    const item = schedule[i];
                    const liElement = ui.scheduleList.querySelector(`li[data-index='${i}']`);
                    if(liElement) liElement.classList.add('running');
                    
                    if (item.type === 'command') {
                        const pollDelay = parseInt(ui.pollDelay.value) || 500;
                        for (const cmd of item.commands) {
                             if (!isSequenceRunning) break;
                             await sendRawCommand(cmd);
                             await new Promise(resolve => setTimeout(resolve, pollDelay));
                        }
                    } else if (item.type === 'delay') {
                         await new Promise(resolve => setTimeout(resolve, item.duration));
                    } else if (item.type === 'if') {
                        ifBlockMetStack.push(false);
                        const ifConditionMet = (lastReadValue.id === item.condition.id && lastReadValue.value === item.condition.value);
                        
                        console.log(`Schedule IF check: Last read value for ID ${lastReadValue.id} is ${lastReadValue.value}. Condition is (ID ${item.condition.id} == ${item.condition.value}). Result: ${ifConditionMet}`);
                        
                        if (ifConditionMet) {
                            ifBlockMetStack[ifBlockMetStack.length - 1] = true;
                        } else {
                            i = findNextClause(i) - 1; 
                        }
                    } else if (item.type === 'elseif') {
                         if (ifBlockMetStack.length > 0 && ifBlockMetStack[ifBlockMetStack.length - 1] === true) {
                            i = findMatchingEndif(i) - 1;
                        } else {
                            const elseifConditionMet = (lastReadValue.id === item.condition.id && lastReadValue.value === item.condition.value);
                            if (elseifConditionMet) {
                                if (ifBlockMetStack.length > 0) ifBlockMetStack[ifBlockMetStack.length - 1] = true;
                            } else {
                                i = findNextClause(i) - 1;
                            }
                        }
                    } else if (item.type === 'else') {
                         if (ifBlockMetStack.length > 0 && ifBlockMetStack[ifBlockMetStack.length - 1] === true) {
                            i = findMatchingEndif(i) - 1;
                        }
                    } else if (item.type === 'endif') {
                         if(ifBlockMetStack.length > 0) ifBlockMetStack.pop();
                    }
                    
                    if(liElement) liElement.classList.remove('running');
                    const pollDelay = parseInt(ui.pollDelay.value) || 500;
                    if (isSequenceRunning && item.type !== 'delay' && !(item.type === 'command' && item.commands.length > 1)) {
                         await new Promise(r => setTimeout(r, pollDelay));
                    }
                    i++;
                }
                if (!isSequenceRunning) break;
            } while (shouldLoop && isSequenceRunning);
            
            stopSchedule();
        }

        function stopSchedule() {
             isSequenceRunning = false;
             isPaused = false;
             ui.runScheduleButton.disabled = !port;
             ui.stopScheduleButton.disabled = true;
             ui.pauseScheduleButton.disabled = true;
             ui.pauseScheduleButton.innerHTML = '⏸️ 暫停';
             const runningEl = ui.scheduleList.querySelector('.running, .paused');
             if(runningEl) runningEl.classList.remove('running', 'paused');
        }
        
        // --- Event Listeners ---
        ui.connectButton.addEventListener('click', () => port ? disconnect() : connect());

        const inputs = [ ui.slaveId, ui.motorSpeed, ui.motorDirection, ui.motorRevolutions, ui.meteorSpeed, ui.meteorCount,
            ui.effectColorR, ui.effectColorG, ui.effectColorB, ui.effectBrightness, ui.effectOnTime, ui.effectOffTime, ui.effectLedCount,
            ui.effectOnOff, ui.breathingTime, ui.blinkingOnTime, ui.blinkingOffTime, ui.newSlaveId ];
        inputs.forEach(input => input.addEventListener('input', generateAllCommands));
        ui.effectBrightness.addEventListener('input', () => ui.effectBrightnessValue.textContent = ui.effectBrightness.value);
        
        ui.sendButtons.forEach(button => button.addEventListener('click', () => sendCommand(button.dataset.target)));
        
        ui.effectTriggerButtons.forEach(button => button.addEventListener('click', async () => {
            const effectId = parseInt(button.dataset.effectId);
            generateEffectCommand(effectId);
            const paramsCmd = JSON.parse(ui.commandDisplays.effect.dataset.paramsCommand);
            const triggerCmd = JSON.parse(ui.commandDisplays.effect.dataset.triggerCommand);
            const pollDelay = parseInt(ui.pollDelay.value) || 500;
            await sendRawCommand(paramsCmd);
            await new Promise(r => setTimeout(r, pollDelay));
            await sendRawCommand(triggerCmd);
        }));

        ui.executeMotorMove.addEventListener('click', async () => {
            const paramsCmd = JSON.parse(ui.commandDisplays.motorMove.dataset.paramsCommand);
            const execCmd = JSON.parse(ui.commandDisplays.motorMove.dataset.executeCommand);
            const pollDelay = parseInt(ui.pollDelay.value) || 500;
            await sendRawCommand(paramsCmd);
            await new Promise(r => setTimeout(r, pollDelay));
            await sendRawCommand(execCmd);
        });

        ui.triggerMeteor.addEventListener('click', async () => {
            const paramsCmd = JSON.parse(ui.commandDisplays.meteor.dataset.paramsCommand);
            const triggerCmd = JSON.parse(ui.commandDisplays.meteor.dataset.triggerCommand);
            const pollDelay = parseInt(ui.pollDelay.value) || 500;
            await sendRawCommand(paramsCmd);
            await new Promise(r => setTimeout(r, pollDelay));
            await sendRawCommand(triggerCmd);
        });

        ui.forceIdButton.addEventListener('click', async () => {
            generateForceIdCommand();
            await sendCommand('forceId');
            alert('ID 設定指令已發送，裝置將重新啟動。請斷開並使用新的 Slave ID 重新連接。');
            disconnect();
        });

        ui.revertIdButton.addEventListener('click', async () => {
             const slaveId = parseInt(ui.slaveId.value);
             const cmd = generateAndDisplayCommand('forceId', [slaveId, 0x06, 0x00, 23, 0x00, 0]);
             await sendRawCommand(cmd);
             alert('ID 還原指令已發送，裝置將重新啟動。請斷開並使用硬體 DIP 開關設定的 ID 重新連接。');
             disconnect();
        });
        
        // Generic Command Listeners
        function calculateGenericCommand() {
            const inputStr = ui.genericCommandInput.value.trim().replace(/[^0-9a-fA-F\s]/g, '').replace(/\s+/g, ' ').trim();
            ui.genericCommandInput.value = inputStr.toUpperCase();
            const hexValues = inputStr.split(' ');
            if (hexValues[0] === "") return ui.genericCommandOutput.textContent = '請輸入指令...';
            const bytes = hexValues.map(hex => parseInt(hex, 16));
            if (bytes.some(isNaN)) return ui.genericCommandOutput.textContent = '無效的Hex指令...';
            const crc = crc16(bytes);
            const fullCommand = [...bytes, crc & 0xFF, (crc >> 8) & 0xFF];
            ui.genericCommandOutput.textContent = fullCommand.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        }
        async function sendGenericCommand() {
            const commandText = ui.genericCommandOutput.textContent;
            if (!commandText || commandText.includes('...')) return alert('無效或空的指令!');
            const bytes = commandText.split(' ').map(hex => parseInt(hex, 16));
            await sendRawCommand(bytes);
        }
        ui.genericCommandInput.addEventListener('input', calculateGenericCommand);
        ui.copyGenericCommand.addEventListener('click', () => {
            const commandText = ui.genericCommandOutput.textContent;
            if (commandText && !commandText.includes('...')) {
                navigator.clipboard.writeText(commandText).then(() => {
                    ui.copyFeedback.textContent = '複製成功!';
                    setTimeout(() => { ui.copyFeedback.textContent = ''; }, 2000);
                });
            }
        });
        ui.sendGenericCommand.addEventListener('click', sendGenericCommand);
        
        // Log buttons
        ui.clearLogButton.addEventListener('click', () => ui.logContainer.innerHTML = '');
        ui.saveLogButton.addEventListener('click', () => {
            const logText = ui.logContainer.innerText;
            if (!logText) return alert('日誌是空的!');
            const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modbus_log_${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });

        ui.addToScheduleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const target = button.dataset.target;
                const baseDescription = button.dataset.desc;
                const slaveId = ui.slaveId.value;
                let description = `ID-${slaveId}: ${baseDescription}`;
                const note = ui.scheduleNote.value.trim();
                let commands = [];
                
                if (target === 'effect') {
                    const effectId = parseInt(ui.commandDisplays.effect.dataset.effectId);
                    const effectName = {0: '關閉', 1: '恆亮', 2: '呼吸', 3: '閃爍'}[effectId];
                    description += ` (${effectName})`;
                    generateEffectCommand(effectId);
                    commands.push(JSON.parse(ui.commandDisplays.effect.dataset.paramsCommand));
                    commands.push(JSON.parse(ui.commandDisplays.effect.dataset.triggerCommand));
                } else if (target === 'motorMove') {
                    commands.push(JSON.parse(ui.commandDisplays.motorMove.dataset.paramsCommand));
                    commands.push(JSON.parse(ui.commandDisplays.motorMove.dataset.executeCommand));
                    description += ` (${ui.motorRevolutions.value} 圈, ${ui.motorDirection.options[ui.motorDirection.selectedIndex].text})`;
                } else if (target === 'meteor') {
                    commands.push(JSON.parse(ui.commandDisplays.meteor.dataset.paramsCommand));
                    commands.push(JSON.parse(ui.commandDisplays.meteor.dataset.triggerCommand));
                } else {
                    commands.push(JSON.parse(ui.commandDisplays[target].dataset.command));
                }
                
                schedule.push({type: 'command', description, commands, note});
                renderSchedule();
                ui.scheduleNote.value = '';
            });
        });

        ui.addDelayButton.addEventListener('click', () => {
            const duration = parseInt(ui.delayTime.value);
            if(duration > 0) schedule.push({type: 'delay', description: `延遲 ${duration} ms`, duration, note: ui.scheduleNote.value.trim()});
            renderSchedule();
        });
        ui.addIfButton.addEventListener('click', () => {
            const id = parseInt(ui.ifSlaveId.value);
            const value = parseInt(ui.ifValue.value);
            schedule.push({type: 'if', description: `If (ID-${id} LastStatus == ${value})`, condition: { id, value }, note: ui.scheduleNote.value.trim() });
            renderSchedule();
        });
         ui.addElseIfButton.addEventListener('click', () => {
            const id = parseInt(ui.elseifSlaveId.value);
            const value = parseInt(ui.elseifValue.value);
            schedule.push({type: 'elseif', description: `Else If (ID-${id} LastStatus == ${value})`, condition: { id, value }, note: ui.scheduleNote.value.trim() });
            renderSchedule();
        });
        ui.addElseButton.addEventListener('click', () => { schedule.push({type: 'else', description: 'Else', note: ui.scheduleNote.value.trim()}); renderSchedule(); });
        ui.addEndIfButton.addEventListener('click', () => { schedule.push({type: 'endif', description: 'End If', note: ui.scheduleNote.value.trim()}); renderSchedule(); });
        ui.clearScheduleButton.addEventListener('click', () => { schedule = []; renderSchedule(); });
        ui.runScheduleButton.addEventListener('click', executeSchedule);
        ui.pauseScheduleButton.addEventListener('click', () => {
            isPaused = !isPaused;
            ui.pauseScheduleButton.innerHTML = isPaused ? '▶️ 繼續' : '⏸️ 暫停';
            const runningEl = ui.scheduleList.querySelector('.running');
            if(runningEl) isPaused ? runningEl.classList.add('paused') : runningEl.classList.remove('paused');
        });
        ui.stopScheduleButton.addEventListener('click', stopSchedule);
        
        ui.saveScheduleButton.addEventListener('click', () => {
             if (schedule.length === 0) return alert('節目表是空的!');
             const blob = new Blob([JSON.stringify(schedule, null, 2)], { type: 'application/json' });
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = `modbus_schedule_${new Date().toISOString()}.json`;
             a.click();
             URL.revokeObjectURL(a.href);
        });
        ui.loadScheduleButton.addEventListener('click', () => ui.scheduleFileInput.click());
        ui.scheduleFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (Array.isArray(loadedData)) {
                        schedule = loadedData;
                        renderSchedule();
                        alert('節目表已成功載入!');
                    } else throw new Error("Invalid format");
                } catch (error) {
                    alert('讀取檔案失敗，格式錯誤。');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        // --- Initial Setup ---
        for (let i = 1; i <= 247; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            ui.slaveId.appendChild(option);
        }
        generateAllCommands();

        // --- Particle Background (unchanged) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationFrameId;
        function setupCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        class Particle { constructor(x, y, dX, dY, s, c) { this.x=x;this.y=y;this.dX=dX;this.dY=dY;this.s=s;this.c=c; } draw() { ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2,false); ctx.fillStyle=this.c; ctx.fill(); } update() { if(this.x>canvas.width||this.x<0)this.dX=-this.dX; if(this.y>canvas.height||this.y<0)this.dY=-this.dY; this.x+=this.dX; this.y+=this.dY; this.draw(); } }
        function initParticles() { particles=[]; let num=(canvas.height*canvas.width)/9000; for(let i=0;i<num;i++){ let s=(Math.random()*2)+1,x=(Math.random()*((innerWidth-s*2)-(s*2))+s*2),y=(Math.random()*((innerHeight-s*2)-(s*2))+s*2),dX=(Math.random()*.4)-.2,dY=(Math.random()*.4)-.2,c='rgba(200,200,200,0.8)'; particles.push(new Particle(x,y,dX,dY,s,c)); } }
        function connectParticles() { let op=1; for(let a=0;a<particles.length;a++){ for(let b=a;b<particles.length;b++){ let dist=((particles[a].x-particles[b].x)**2)+((particles[a].y-particles[b].y)**2); if(dist<(canvas.width/7)*(canvas.height/7)){ op=1-(dist/20000); ctx.strokeStyle=`rgba(200,200,200,${op})`; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(particles[a].x,particles[a].y); ctx.lineTo(particles[b].x,particles[b].y); ctx.stroke(); } } } }
        function animateParticles() { animationFrameId = requestAnimationFrame(animateParticles); ctx.fillStyle='#111827'; ctx.fillRect(0,0,canvas.width,canvas.height); for(let i=0;i<particles.length;i++)particles[i].update(); connectParticles(); }
        window.addEventListener('resize', () => { cancelAnimationFrame(animationFrameId); setupCanvas(); initParticles(); animateParticles(); });
        setupCanvas(); initParticles(); animateParticles();

        // --- Collapsible Section Logic ---
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.toggle-icon');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    icon.classList.remove('rotate-180');
                } else {
                    document.querySelectorAll('.collapsible-content').forEach(c => c.style.maxHeight = null);
                    document.querySelectorAll('.toggle-icon').forEach(i => i.classList.remove('rotate-180'));
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.classList.add('rotate-180');
                }
            });
        });
        
        // Open the first section by default
        const firstHeader = document.querySelector('.collapsible-header');
        if (firstHeader) firstHeader.click();
    });
</script>

</body>
</html>

