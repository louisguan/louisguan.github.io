<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Page Cropper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/react-image-crop/dist/ReactCrop.css"
    />
    <script type="importmap">
      {
        "imports": {
          "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
          "react/": "https://aistudiocdn.com/react@^19.2.0/",
          "react": "https://aistudiocdn.com/react@^19.2.0",
          "react-image-crop": "https://aistudiocdn.com/react-image-crop@^11.0.10"
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-gray-900 text-gray-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      // CDN Imports from Import-Map
      import React, { useState, useCallback, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import ReactCrop from 'react-image-crop';

      // --- Inlined components/Icons.jsx ---
      const UploadIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          {...props}
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" x2="12" y1="3" y2="15" />
        </svg>
      );

      const CropIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          {...props}
        >
          <path d="M6.13 1L6 16a2 2 0 0 0 2 2h15" />
          <path d="M1 6.13L16 6a2 2 0 0 1 2 2v15" />
        </svg>
      );

      const DownloadIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          {...props}
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="7 10 12 15 17 10" />
          <line x1="12" x2="12" y1="15" y2="3" />
        </svg>
      );

      const ResetIcon = (props) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          {...props}
        >
          <path d="M3 2v6h6" />
          <path d="M21 12A9 9 0 0 0 6 5.3L3 8" />
          <path d="M21 22v-6h-6" />
          <path d="M3 12a9 9 0 0 0 15 6.7l3-2.7" />
        </svg>
      );

      const FileIcon = (props) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width="24" 
          height="24" 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round"
          {...props}
          >
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
      );

      // --- Inlined components/Spinner.jsx ---
      const Spinner = () => {
        return (
          <div className="flex flex-col items-center justify-center space-y-4 my-8">
              <div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-400"></div>
              <p className="text-lg text-gray-400">Processing your PDF, please wait...</p>
          </div>
        );
      };

      // --- Inlined components/FileUpload.jsx ---
      const FileUpload = ({ onFileChange }) => {
        const [isDragging, setIsDragging] = useState(false);

        const handleDrag = useCallback((e) => {
          e.preventDefault();
          e.stopPropagation();
          if (e.type === 'dragenter' || e.type === 'dragover') {
            setIsDragging(true);
          } else if (e.type === 'dragleave') {
            setIsDragging(false);
          }
        }, []);

        const handleDrop = useCallback((e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(false);
          if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            if (e.dataTransfer.files[0].type === "application/pdf") {
              onFileChange(e.dataTransfer.files[0]);
            } else {
              alert("Please upload a valid PDF file.");
            }
          }
        }, [onFileChange]);

        const handleChange = (e) => {
          if (e.target.files && e.target.files[0]) {
              onFileChange(e.target.files[0]);
          }
        };

        return (
          <div className="max-w-xl mx-auto mt-12">
            <label
              onDragEnter={handleDrag}
              onDragLeave={handleDrag}
              onDragOver={handleDrag}
              onDrop={handleDrop}
              className={`flex justify-center w-full h-64 px-4 transition-all duration-300 bg-gray-800 border-4 border-dashed rounded-xl appearance-none cursor-pointer hover:border-indigo-500 focus:outline-none ${isDragging ? 'border-indigo-500 bg-gray-700' : 'border-gray-600'}`}
            >
              <span className="flex flex-col items-center justify-center space-y-4">
                <UploadIcon className={`w-16 h-16 ${isDragging ? 'text-indigo-400' : 'text-gray-500'} transition-colors duration-300`} />
                <span className="font-medium text-gray-300">
                  <span className="text-indigo-400">Click to upload</span> or drag and drop a PDF
                </span>
                <span className="text-xs text-gray-500">
                  Your file will be processed entirely in your browser
                </span>
              </span>
              <input
                type="file"
                name="file_upload"
                className="hidden"
                accept="application/pdf"
                onChange={handleChange}
              />
            </label>
          </div>
        );
      };

      // --- Inlined components/ImageCropper.jsx ---
      function getCroppedImg(
          image,
          crop,
          fileName
      ) {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          if (!ctx) {
              return Promise.reject(new Error('Could not get canvas context'));
          }

          const scaleX = image.naturalWidth / image.width;
          const scaleY = image.naturalHeight / image.height;
          
          const cropWidth = crop.width * scaleX;
          const cropHeight = crop.height * scaleY;

          canvas.width = cropWidth;
          canvas.height = cropHeight;

          ctx.imageSmoothingQuality = "high";

          ctx.drawImage(
              image,
              crop.x * scaleX,
              crop.y * scaleY,
              cropWidth,
              cropHeight,
              0,
              0,
              cropWidth,
              cropHeight
          );

          return new Promise((resolve) => {
              resolve(canvas.toDataURL("image/png"));
          });
      }

      const ImageCropper = ({ page, onCropComplete }) => {
        const [crop, setCrop] = useState();
        const [completedCrop, setCompletedCrop] = useState();
        const [isCropping, setIsCropping] = useState(false);
        const imgRef = useRef(null);

        const onImageLoad = (e) => {
          setCrop({
              unit: '%',
              x: 5,
              y: 5,
              width: 90,
              height: 90,
          });
        };

        const handleCrop = async () => {
          if (completedCrop?.width && completedCrop?.height && imgRef.current) {
            setIsCropping(true);
            try {
              const croppedImageUrl = await getCroppedImg(
                imgRef.current,
                completedCrop,
                `page_${page.id}_cropped.png`
              );
              onCropComplete(page.id, croppedImageUrl);
            } catch (e) {
              console.error("Cropping failed", e);
            } finally {
              setIsCropping(false);
            }
          }
        };

        const handleDownload = () => {
          if (page.croppedSrc) {
              const link = document.createElement('a');
              link.href = page.croppedSrc;
              link.download = `page_${page.id}_cropped.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
        };

        return (
          <div className="bg-gray-800 rounded-xl shadow-2xl p-6 flex flex-col space-y-4 transform hover:scale-[1.02] transition-transform duration-300">
            <h3 className="text-xl font-bold text-center text-indigo-400">Page {page.id}</h3>
            <div className="bg-black/20 rounded-lg overflow-hidden">
              <ReactCrop
                crop={crop}
                onChange={(_, percentCrop) => setCrop(percentCrop)}
                onComplete={(c) => setCompletedCrop(c)}
              >
                <img ref={imgRef} src={page.originalSrc} alt={`Page ${page.id}`} onLoad={onImageLoad} />
              </ReactCrop>
            </div>

            <div className="flex justify-center space-x-4">
              <button
                onClick={handleCrop}
                disabled={isCropping || !completedCrop?.width}
                className="flex items-center justify-center w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
              >
                {isCropping ? 'Cropping...' : <><CropIcon className="w-5 h-5 mr-2" /> Crop Image</>}
              </button>
            </div>
            
            {page.croppedSrc && (
              <div className="border-t border-gray-700 pt-4 mt-4 space-y-3">
                  <h4 className="text-lg font-semibold text-center text-gray-300">Cropped Result</h4>
                  <div className="bg-black/20 rounded-lg p-2">
                      <img src={page.croppedSrc} alt={`Cropped page ${page.id}`} className="max-w-full h-auto rounded-md mx-auto" />
                  </div>
                  <button
                      onClick={handleDownload}
                      className="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform duration-200 transform hover:scale-105"
                  >
                      <DownloadIcon className="w-5 h-5 mr-2" />
                      Download Cropped
                  </button>
              </div>
            )}
          </div>
        );
      };
      
      // --- Inlined App.jsx ---
      const App = () => {
        const [imagePages, setImagePages] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [pdfName, setPdfName] = useState('');
        const [pdfFile, setPdfFile] = useState(null);

        const processPdf = useCallback(async (file) => {
          if (!file) return;

          setIsLoading(true);
          setError(null);
          setImagePages([]);
          setPdfName(file.name);

          const fileReader = new FileReader();
          fileReader.onload = async () => {
            try {
              const typedarray = new Uint8Array(fileReader.result);
              const pdf = await pdfjsLib.getDocument(typedarray).promise;
              const pages = [];
              const scale = 5.0; // Increased scale for higher resolution (approx. 360 DPI)

              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                if (!context) {
                  throw new Error('Failed to get canvas context');
                }

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport }).promise;
                
                pages.push({
                  id: i,
                  originalSrc: canvas.toDataURL('image/png'),
                  croppedSrc: null,
                });
              }
              setImagePages(pages);
            } catch (e) {
              console.error(e);
              setError('Failed to process the PDF. Please ensure it is a valid and not corrupted file.');
            } finally {
              setIsLoading(false);
            }
          };
          fileReader.readAsArrayBuffer(file);
        }, []);
        
        useEffect(() => {
          if (pdfFile) {
              processPdf(pdfFile);
          }
        }, [pdfFile, processPdf]);


        const handleFileChange = (file) => {
          if (file) {
            setPdfFile(file);
          }
        };

        const handleCropComplete = useCallback((id, croppedSrc) => {
          setImagePages((prevPages) =>
            prevPages.map((page) =>
              page.id === id ? { ...page, croppedSrc } : page
            )
          );
        }, []);

        const handleReset = () => {
          setImagePages([]);
          setPdfFile(null);
          setPdfName('');
          setError(null);
          setIsLoading(false);
        };

        return (
          <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
              <header className="text-center mb-8">
                <h1 className="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-600">
                  PDF Page Cropper
                </h1>
                <p className="mt-2 text-lg text-gray-400">
                  Convert PDF pages to PNGs and crop them with ease.
                </p>
              </header>

              <main>
                {isLoading && <Spinner />}
                {error && (
                  <div className="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg relative text-center" role="alert">
                    <strong className="font-bold">Error: </strong>
                    <span className="block sm:inline">{error}</span>
                  </div>
                )}

                {!isLoading && !error && imagePages.length === 0 && (
                  <FileUpload onFileChange={handleFileChange} />
                )}

                {imagePages.length > 0 && (
                  <div>
                    <div className="flex justify-between items-center bg-gray-800 p-4 rounded-lg mb-8 shadow-lg">
                      <div className="flex items-center space-x-3">
                        <FileIcon className="w-6 h-6 text-indigo-400" />
                        <span className="font-medium text-gray-300 truncate">{pdfName}</span>
                      </div>
                      <button
                        onClick={handleReset}
                        className="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform duration-200 transform hover:scale-105"
                      >
                        <ResetIcon className="w-5 h-5" />
                        <span>Start Over</span>
                      </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {imagePages.map((page) => (
                        <ImageCropper
                          key={page.id}
                          page={page}
                          onCropComplete={handleCropComplete}
                        />
                      ))}
                    </div>
                  </div>
                )}
              </main>
            </div>
          </div>
        );
      };
      
      // --- Inlined index.jsx (App Entry Point) ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
